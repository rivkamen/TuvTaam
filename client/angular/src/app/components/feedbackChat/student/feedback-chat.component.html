<div class="chat-layout">

  <!-- ×¨×©×™××ª ×©×™×—×•×ª -->
  <div class="session-list">
    <button *ngFor="let s of sessions"
            class="session-item"
            [class.selected]="s._id === selectedSessionId"
            (click)="selectSession(s._id)">
      {{ s.createdAt || (s._id ? '×©×™×—×” #' + s._id.slice(-4) : '×©×™×—×” ×œ×œ× ××–×”×”') }}
    </button>
    <button class="new-session-btn" (click)="startNewSession()">+ ×©×™×—×” ×—×“×©×”</button>
  </div>

  <!-- ×¦'××˜ -->
  <div class="chat-container">
    
    <!-- ×¤×¨×•×¤×™×œ -->
    <div class="user-profile-bar" *ngIf="userEmail">
      <img *ngIf="userPhotoUrl" [src]="roleService.isAdmin() ? adminPhotoUrl : userPhotoUrl" class="profile-img" />
      <span class="email">{{ userEmail }}</span>
    </div>

    <!-- ×™×¦×™×¨×ª ×©×™×—×” ×—×“×©×” -->
    <div *ngIf="newSessionMode" class="new-session-box">
      <input type="text" [(ngModel)]="newSessionTitle" placeholder="×©× ×”×©×™×—×” (×œ× ×—×•×‘×”)" />
      <textarea [(ngModel)]="newSessionMessage" placeholder="×›×ª×•×‘ ××ª ×”×”×•×“×¢×” ×”×¨××©×•× ×”..."></textarea>
      <button (click)="createNewSession()">×©×œ×—</button>
      <button (click)="cancelNewSession()">×‘×™×˜×•×œ</button>
    </div>

    <!-- ×ª×¦×•×’×ª ×©×™×—×” ×§×™×™××ª -->

    <div *ngIf="!newSessionMode && selectedSessionId">
      <div *ngIf="loading">×˜×•×¢×Ÿ ×”×•×“×¢×•×ª...</div>
     <p-scrollPanel #scrollPanel styleClass="messages-container" [style]="{height: '400px'}">

<div *ngFor="let msg of messages; trackBy: trackByMessageId"
     class="message-wrapper" 
     [ngClass]="msg.fromUser ? 'user' : 'admin'">

  <!-- ğŸ§‘â€ğŸ’¼ ×ª×¦×•×’×ª ×¤×¨×•×¤×™×œ -->
  <div class="message-profile">
    <img [src]="msg.fromUser ? userPhotoUrl : adminPhotoUrl"
         alt="×ª××•× ×ª ×¤×¨×•×¤×™×œ"
         class="profile-img-small" />
  </div>
        <!-- ×”×•×“×¢×” -->
        <div *ngIf="editMessageId === msg._id; else showMessage">
          <textarea [(ngModel)]="editedMessageContent"></textarea>
          <button (click)="saveEdit(msg._id)">×©××™×¨×”</button>
          <button (click)="cancelEdit()">×‘×™×˜×•×œ</button>
        </div>

        <ng-template #showMessage>
          <div class="bubble">
            <!-- <div *ngIf="msg.content">{{ msg.content }}</div>
            
            <audio *ngIf="msg.signedUrl" [src]="getSafeUrl(msg.signedUrl)" controls></audio>
           -->

<div *ngIf="msg.content">{{ msg.content }}</div>
 <app-audio-player *ngIf="msg.safeAudioUrl" [src]="msg.safeAudioUrl" controls
  preload="none"
  (error)="onAudioError(msg)"></app-audio-player>
<!-- <audio *ngIf="msg.safeAudioUrl" [src]="msg.safeAudioUrl" controls></audio> -->

</div>

          <div class="msg-menu-wrapper" *ngIf="msg.fromUser">
            <button class="menu-toggle-btn" (click)="toggleMenu(msg._id)">â‹®</button>
            <div class="msg-menu" *ngIf="openedMenuId === msg._id">
              <button (click)="startEdit(msg)">
                <i class="pi pi-pencil"></i> ×¢×¨×™×›×”
              </button>
              <button (click)="deleteMessage(msg._id)">
                <i class="pi pi-trash"></i> ××—×™×§×”
              </button>
            </div>
          </div>
        </ng-template>
      </div>
</p-scrollPanel>

      <!-- ×©×“×” ×”×–× ×ª ×”×•×“×¢×” -->
      <div class="message-input">
        <input [(ngModel)]="newMessage" placeholder="×”×§×œ×“ ×”×•×“×¢×”..." (keydown.enter)="sendMessage()" />
        <!-- ×›×¤×ª×•×¨ ×”×ª×—×œ×ª ×”×§×œ×˜×” -->
<div class="start-recording" *ngIf="!isRecording && !recordedBlob">
  <!-- <button class="icon-btn record" (click)="startRecording()" title="×”×ª×—×œ ×”×§×œ×˜×”"> -->
    <button class="icon-btn record" (click)="openRecordingDialog()" title="×”×ª×—×œ ×”×§×œ×˜×”">

    <i class="pi pi-microphone"></i>
  </button>
</div>

      <button type="button" class="send-btn" (click)="sendMessage()">
        <i class="pi pi-send"></i>
      </button>  </div>    
<app-recording
  *ngIf="isDialogOpen"
  (closed)="closeDialog()"
  (audioRecorded)="handleRecordedAudio($event)"
  class="recording-dialog-overlay"
></app-recording>



