<div class="chat-layout">

  <!-- רשימת השיחות -->
  <div class="session-list">
    <button *ngFor="let s of sessions"
            class="session-item"
            [class.selected]="s._id === selectedSessionId"
            (click)="selectSession(s._id)">
      {{ s.title || (s._id ? 'שיחה #' + s._id.slice(-4) : 'שיחה ללא מזהה') }}
    </button>
    <button class="new-session-btn" (click)="startNewSession()">+ שיחה חדשה</button>
  </div>

  <!-- תיבת צ'אט -->
  <div class="chat-container">

    <!-- תיבת יצירת שיחה חדשה -->
    <div *ngIf="newSessionMode" class="new-session-box">
      <input type="text" [(ngModel)]="newSessionTitle" placeholder="שם השיחה (לא חובה)" />
      <textarea [(ngModel)]="newSessionMessage" placeholder="כתוב את ההודעה הראשונה..."></textarea>
      <button (click)="createNewSession()">שלח</button>
      <button (click)="cancelNewSession()">ביטול</button>
    </div>

    <!-- הודעות קיימות -->
    <div *ngIf="!newSessionMode && selectedSessionId">
      <div *ngIf="loading">טוען הודעות...</div>

      <div class="messages">
        <div *ngFor="let msg of messages"
        
             class="message-wrapper"
             [ngClass]="msg.fromUser ? 'user' : 'admin'">

<div class="bubble">
  <div *ngIf="msg.content">{{ msg.content }}</div>
  <audio *ngIf="msg.signedUrl" [src]="getSafeUrl(msg.signedUrl)" controls></audio>
</div>


          </div>
        </div>
      </div>

    
<div class="message-input-bar">
  <!-- הודעה -->
  <input
    type="text"
    [(ngModel)]="newMessage"
    placeholder="כתוב הודעה..."
    (keydown.enter)="sendMessage()"
  />

  <!-- אזור הקלטה -->
  <div class="recording-controls">

    <!-- אם מקליטים -->
    <ng-container *ngIf="isRecording; else micButton">
      <span class="recording-indicator">🔴 {{ recordingTime | date:'mm:ss' }}</span>
      <button type="button" class="stop-btn" (click)="stopRecording()">
        <i class="pi pi-stop"></i>
      </button>
    </ng-container>

    <!-- כפתור הקלטה (כאשר לא מקליטים) -->
    <ng-template #micButton>
      <button type="button" class="mic-btn" (click)="startRecording()">
        <i class="pi pi-microphone"></i>
      </button>
    </ng-template>
  </div>

  <!-- תצוגת ההקלטה (אם קיימת) -->
  <div *ngIf="recordedBlob" class="audio-preview">
    <audio [src]="getSafeUrlFromBlob(recordedBlob)" controls></audio>
    <button type="button" (click)="removeRecording()">
      <i class="pi pi-times"></i>
    </button>
  </div>

  <!-- כפתור שליחה -->
  <button type="button" class="send-btn" (click)="sendMessage()">
    <i class="pi pi-send"></i>
  </button>
</div>

    </div>
  </div>